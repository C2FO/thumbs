// Thumbs.js 0.1.2
//
// Copyright (c) 2013 Pollenware.
// Distributed under MIT license.
//
// http://thumbsjs.com
(function(){function defineThumbs(Backbone,_){var previousThumbs=root.Thumbs,Thumbs={},_extend=Backbone.Model.extend;return Backbone.Thumbs=Thumbs,Thumbs.MULTI_ARG_TOKEN=/ +/,Thumbs.KEY_VALUE_TOKEN=":",Thumbs.noConflict=function(){return root.Thumbs=previousThumbs,this},Thumbs.viewRegistry=function(){var t={},e=0,i={_hash:t,getEnclosingView:function(e){for(var i,s=e;s;){if(s!==e&&(i=1===s.nodeType&&s.getAttribute("thumbs-id")))return t[i];s=s.parentNode}return null},remove:function(i){t.hasOwnProperty(i)&&(delete t[i],e--)},add:function(i){var s=i.thumbsId;if(t.hasOwnProperty(s))throw Error("Tried to register view with id "+s+" but that id is already registered");s&&(t[s]=i,e++)},get:function(e){return"string"==typeof e?t[e]:e},uniqueId:function(){return _.uniqueId("thumbs_view_")},getSubViews:function(e){function i(e){var i,n,r;for(n=e.firstChild;n;n=n.nextSibling)1===n.nodeType&&(i=n.getAttribute("thumbs-id"))&&(r=t[i])&&s.push(r)}var s=[];return i(e),s},getByNode:function(e){return e?t[e.thumbsId||e.getAttribute("thumbs-id")]:void 0},toArray:function(){return _.values(t)}};return i}(),Thumbs.viewByNode=Thumbs.viewRegistry.getByNode,Thumbs.viewById=Thumbs.viewRegistry.get,Thumbs.extend=function(){var t=_extend.apply(this,arguments);return t.prototype.__getConstructor=function(){return t},t},Backbone.Model.extend=Backbone.Collection.extend=Backbone.View.extend=Backbone.History.extend=Backbone.Router.extend=Thumbs.extend,Thumbs._super={_super:function(){function t(t,e){for(var i=e;i[t]===e[t]&&i.__getConstructor;){var s=i.__getConstructor();i=s.__super__}return i}return function(e,i){this._superCallObjects||(this._superCallObjects={});var s,n=this._superCallObjects[e]||this,r=t(e,n);return this._superCallObjects[e]=r,s=r[e].apply(this,i||{}),delete this._superCallObjects[e],s}}()},Thumbs.Events=Backbone.Events,Thumbs.sync=Backbone.sync,Thumbs.Class=function(){var t=function(){this.cid=_.uniqueId("class"),this.initialize.apply(this,arguments)};return _.extend(t.prototype,Backbone.Events,Thumbs._super,{initialize:function(){}}),t.extend=Thumbs.extend,t}(),Thumbs.Model=Backbone.Model.extend(Thumbs._super).extend({}),Thumbs.Collection=Backbone.Collection.extend(Thumbs._super).extend({}),Thumbs.Router=Backbone.Router.extend(Thumbs._super).extend({preRoutes:null,_bindRoutes:function(){this.preBind&&_.isFunction(this.preBind)&&this.preBind(),this._super("_bindRoutes",arguments)},route:function(t){return Thumbs.history||(Thumbs.history=Backbone.history),this._super("route",arguments),this.setupPreRoute("all",t),this.setupPreRoute(null,t),this},setupPreRoute:function(t,e){var i,s,n;return t?n="pre-route_"+t+e:(t=e,n="pre-route_"+e),this.preRoutes&&this.preRoutes[t]&&(s=this.preRoutes[t],_.isString(s)?s=this[s]:_.isArray(s)&&(i=s,s=_.bind(function(){var t,e=!0;for(t=0;i.length>t&&(e=i[t].apply(this),e);++t);return e},this)),_.isRegExp(n)||(n=this._routeToRegExp(n)),Thumbs.history.route(n,_.bind(function(){return s.apply(this)},this))),this}}),Thumbs.View=function(){function splitParts(t,e){return _.each(t.split(thumbs.MULTI_ARG_TOKEN),function(t){e(_.map(t.split(thumbs.KEY_VALUE_TOKEN),function(t){return $.trim(t)}))})}function setElData(t,e,i){var s;if((s=t.attr("thumbs-id"))&&(t=viewRegistry.get(s)||t),i)if("function"==typeof t[i])t[i](e);else if(t.attr)t.attr(i,e);else{if(!(t instanceof View))throw Error("unable to determine how to set data on "+t);t[i]=e}else if(t.is&&t.is("input"))t.is("[type=checkbox], [type=radio]")?t.attr("checked",e):t.val(e);else if(t instanceof View&&t.val)t.val(e);else{if(!t.text)throw Error("unable to determine how to set data on "+t);t.text(e)}}var viewRegistry=Thumbs.viewRegistry,View=Backbone.View.extend(Thumbs._super).extend({_subviews:null,__subviews:null,__identifiers:null,__monitors:null,__events:null,initialize:function(){_.bindAll(this,"setElData","__updateValues","__setValues","setupType","setupBind","setupClassBind","setupEventBind","findThumbsBind","turnOnModelListeners","turnOffModelListeners","setupBinders"),this.thumbsId=viewRegistry.uniqueId(),viewRegistry.add(this),this._subviews={},this.__subviews=[],this.__identifiers=[],this.__monitors={},this.__events={},this._super("initialize",arguments),this.$el&&this.$el.attr("thumbs-id",this.thumbsId)},__updateValues:function(){return this.model&&this.model instanceof Thumbs.Model?this.__setValues(this.model.changedAttributes()):this},__setValues:function(t){var e=this.__monitors;e&&_.each(t,function(t,i){var s=e[i];s&&_.each(s,function(e){e(t)})})},setElData:function(t,e,i){return this.checkFormatting(t,e,i),this},setupType:function(t,e,i){var s=this.__monitors;t in s||(s[t]=[]),s[t].push(_.bind(function(s){"function"==typeof e?e(s,t):this.setElData(e,s,i,t)},this))},setupBind:function(t){if(viewRegistry.getEnclosingView(t)===this){var e=$(t),i=this.setupType;splitParts(e.data("thumbs-bind"),function(e){if(1===e.length)i(e[0],t);else{if(2!==e.length)throw new TypeError("Invalid data-thumbs-bind definition");i(e[1],t,e[0])}})}},setupClassBind:function(t){if(viewRegistry.getEnclosingView(t)===this){var e=$(t),i=this.setupType;splitParts(e.data("thumbs-bind-class"),function(t){if(2!==t.length)throw new TypeError("Invalid data-thumbs-bind-class definition");var s=t[0];i(t[1],function(t){e.toggleClass(s,t)})})}},setupEventBind:function(t){if(viewRegistry.getEnclosingView(t)===this){var e=this.__events,i=$(t),s=this;splitParts(i.data("thumbs-bind-event"),function(t){if(2!==t.length)throw new TypeError("Invalid data-thumbs-bind-class definition");var i=t[0],n=e[i];n||(n=e[i]=[]),n.push(s[t[1]])})}},findThumbsBind:function(){var t=this.setupBind,e=this.setupClassBind,i=this.setupEventBind;return this.$("[data-thumbs-bind]").each(function(){t(this)}),this.$("[data-thumbs-bind-event]").each(function(){i(this)}),this.$("[data-thumbs-bind-class]").each(function(){e(this)}),this.$el.is("[data-thumbs-bind]")&&t(this.el),this.$el.is("[data-thumbs-bind-class]")&&e(this.el),this.$el.is("[data-thumbs-bind-event]")&&i(this.el),this},turnOnModelListeners:function(){var t=this.model||this.collection;if(t){var e=this.__monitors,i=this.__events;e&&_.each(this.__monitors,function(e,i){e.fn=function(t,i){_.each(e,function(t){t.apply(this,[i])},this)},t.on("change:"+i,e.fn,this)},this),i&&_.each(this.__events,function(e,i){e.fn=function(){var t=arguments;_.each(e,function(e){e.apply(this,t)},this)},t.on(i,e.fn,this)},this)}return this},turnOffModelListeners:function(){var t=this.model||this.collection;if(t){var e=this.__monitors,i=this.__events;e&&_.each(this.__monitors,function(e,i){t.off("change:"+i,e.fn,this)},this),i&&_.each(this.__events,function(e,i){t.off(i,e.fn,this)},this)}return this},setupBinders:function(){var t=this.model||this.collection;return this.turnOffModelListeners().findThumbsBind().turnOnModelListeners(),t&&this.__setValues(t.attributes),this},removeIdentifiers:function(){_.each(this.__identifiers,function(t){this[t]=this["$"+t]=null},this),this.__identifiers=[]},checkForIdentifiers:function(){var t=this;return this.removeIdentifiers(),this.$("[data-thumbs-id]").each(function(){if(viewRegistry.getEnclosingView(this)===t){var e=$(this),i=e.data("thumbs-id");t[i]=this,t["$"+i]=viewRegistry.getByNode(this)||e,t.__identifiers.push(i)}}),this},findEl:function(){var t=_.bind(this.setElement,this),e=this.$("[data-thumbs-el]").first().get();return e.length&&(e=e[0],e!==this.el&&t(e)),this},checkFormatting:function(t,e,i){var s,n=$(t),r=Array.prototype.slice.call(arguments,0);return e=r.length>1?e:n.text(),e=null!==e&&e!==void 0?e:"",s=n.data("thumbs-format"),splitParts(s||"",function(t){2===t.length?(i=t[0],s=t[1]):s=t.pop()}),s&&"function"==typeof this[s]&&(e=this[s](e)),setElData(n,e,i),this},renderFormatters:function(){var t=this;return this.$("[data-thumbs-format]").each(function(){t.checkFormatting(this)}),this},setElement:function(){return this._super("setElement",arguments),this.el?this.$el.attr("thumbs-id",this.thumbsId):viewRegistry.remove(this.thumbsId),this},addSubView:function(t,e){return e&&(this.removeSubView(t),this._subviews[t]=e,e.setElement(this.$(t)).render()),this},removeSubView:function(t){var e=this._subviews[t];return e&&(e.setElement(null),e.remove(),this.$(t).empty(),this._subviews[t]=null),this},removeSubViews:function(){return _.each(this._subviews,function(t,e){this.removeSubView(e)},this),this},checkForEvents:function(){var t=this;return this.events=this.events||{},this.$("[data-thumbs-delegate]").each(function(){var e=viewRegistry.get($(this).attr("thumbs-id"));if(viewRegistry.getEnclosingView(this)===t){var i=$(this),s=_.uniqueId("thumbs_");i.addClass(s),splitParts(i.data("thumbs-delegate"),function(i){var n=i[0],r=i[1];t.events[n+" ."+s]=r,e&&t.listenTo(e,n,t[r])})}}),this.delegateEvents(),this},render:function(){return this.checkForSubviews().checkForEvents().setupBinders().checkForIdentifiers().renderFormatters().findEl().assign(this._subviews)._super("render",arguments)},assign:function(t,e){var i;return _.isObject(t)?i=t:t&&(i={},i[t]=e),i&&_.each(i,function(t,e){this.addSubView(e,t)},this),this},_parseViewArgs:function(args){var ret={};if(args)try{_.extend(ret,eval("with(this){({"+args+"})}"))}catch(e){throw Error("Unable to parse data-thumbs-args : "+args+" : "+(""+e))}return ret},renderSubviewView:function(t){var e,i=null,s=$(t),n=s.data("thumbs-view");if(!n||!(i=this[n]))throw Error("Unable to find "+n+" on view");var r=this._parseViewArgs(s.data("thumbs-args"));_.extend(r,{el:t});var u=new i(r);return this.__subviews.push(u.render()),(e=s.data("thumbs-id"))&&(this["$"+e]=u),this},checkForSubviews:function(){var t=this;return this.$("[data-thumbs-view]").each(function(){t.renderSubviewView(this)}),this},remove:function(){return this.__subviews.length&&(_.each(this.__subviews,function(t){t.remove()}),this.__subviews=[]),this.stopListening(),this.removeSubViews(),this.turnOffModelListeners(),this.removeIdentifiers(),this.__monitors={},this.__events={},this._super("remove",arguments)}});return View}(),Thumbs.TemplateView=function(){Thumbs.templater=function(){var t=_.template;return function(e){return e?t=e:t}}();var t=Thumbs.View.extend({templater:null,template:null,initialize:function(){this._super("initialize",arguments),this.templater||(this.templater=thumbs.templater()),this.template&&(this._template=this.templater(this.template))},getTemplateData:function(){return this.model||this.collection?(this.model||this.collection).toJSON():{}},fillTemplate:function(t){return this._template?this._template(t||this.getTemplateData()):null},renderTemplate:function(){if(this._template){var t=this.fillTemplate();t&&this.$el.html(t)}return this},render:function(){return this.renderTemplate()._super("render",arguments)}});return t}(),Thumbs}var root=this;if("object"==typeof exports){var underscore=require("undersore"),backbone=require("backbone");module.exports=defineThumbs(backbone,underscore)}else"function"==typeof define&&define.amd?define(["underscore","backbone"],function(t,e){return defineThumbs(e,t)}):root.Thumbs=root.thumbs=defineThumbs(root.Backbone,root._)}).call(this);