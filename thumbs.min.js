/*! thumbs - v0.0.1 - 2013-01-11
* Copyright (c) 2013 Pollenware; Licensed MIT */
(function(){function defineThumbs(Backbone,_){function argsToArray(e){return slice.call(e,0)}function splitParts(e,t){return _.each(e.split(thumbs.MULTI_ARG_TOKEN),function(e){t(_.map(e.split(thumbs.KEY_VALUE_TOKEN),function(e){return $.trim(e)}))})}function setElData(e,t,n){var r;if(r=e.attr("thumbs-id"))e=viewRegistry.get(r)||e;if(n)if("function"==typeof e[n])e[n](t);else if(e.attr)e.attr(n,t);else{if(!(e instanceof View))throw new Error("unable to determine how to set data on "+e);e[n]=t}else if(e.is&&e.is("input"))e.is("[type=checkbox], [type=radio]")?e.attr("checked",t):e.val(t);else if(e instanceof View&&e.val)e.val(t);else{if(!e.text)throw new Error("unable to determine how to set data on "+e);e.text(t)}}function extend(e,t){var n=_extend.apply(this,arguments);return n.prototype.__getConstructor=function(){return n},n}function Class(e){this.cid=_.uniqueId("class"),this.initialize.apply(this,arguments)}var root=this,ArrayProto=Array.prototype,slice=ArrayProto.slice,thumbs={};_.extend(thumbs,Backbone),thumbs.VERSION="0.0.1",thumbs.MULTI_ARG_TOKEN=/ +/,thumbs.KEY_VALUE_TOKEN=":";var Model=thumbs.Model,View=thumbs.View,Collection=thumbs.Collection,Router=thumbs.Router,History=thumbs.History,viewRegistry=thumbs.viewRegistry=function(){function n(t){return"string"==typeof t?e[t]:t}function r(t){return t?e[t.thumbsId||t.getAttribute("thumbs-id")]:undefined}function i(){return _.values(e)}function s(){return _.uniqueId("thumbs_view_")}function o(t){function r(t){var r,i,s;for(i=t.firstChild;i;i=i.nextSibling)i.nodeType===1&&(r=i.getAttribute("thumbs-id"))&&(s=e[r])&&n.push(s)}var n=[];return r(t),n}function u(n){var r=n.thumbsId;if(e.hasOwnProperty(r))throw new Error("Tried to register view with id "+r+" but that id is already registered");r&&(e[r]=n,t++)}function a(n){e.hasOwnProperty(n)&&(delete e[n],t--)}function f(t){var n,r=t;while(r){if(r!==t&&(n=r.nodeType===1&&r.getAttribute("thumbs-id")))return e[n];r=r.parentNode}return null}var e={},t=0;return{_hash:e,getEnclosingView:f,remove:a,add:u,get:n,uniqueId:s,getSubViews:o,getByNode:r,toArray:i}}();thumbs.viewById=viewRegistry.get,thumbs.viewByNode=viewRegistry.getByNode;var _super={_super:function(){function t(e,t){var n=t;while(n[e]===t[e]){var r=n.__getConstructor();n=r.__super__}return n}return function(n,r){this._superCallObjects||(this._superCallObjects={});var i=this._superCallObjects[n]||this,s=t(n,i);this._superCallObjects[n]=s;var o=s[n].apply(this,r||{});return delete this._superCallObjects[n],o}}()},_extend=thumbs.Model.extend;_.extend(Class.prototype,thumbs.Events,_super,{initialize:function(){}}),thumbs.Class=Class,Class.extend=Model.extend=View.extend=Collection.extend=Router.extend=History.extend=extend,Model=thumbs.Model=Model.extend(_super),View=thumbs.View=View.extend(_super),Collection=thumbs.Collection=Collection.extend(_super),Router=thumbs.Router=Router.extend(_super);var EventDelegator={render:function(){return this._super("render",arguments),this.checkForEvents(),this},checkForEvents:function(){var e=this;return this.events=this.events||{},this.$("[data-thumbs-delegate]").each(function(){var t=viewRegistry.get($(this).attr("thumbs-id"));if(viewRegistry.getEnclosingView(this)===e){var n=$(this),r=_.uniqueId("thumbs_");n.addClass(r),splitParts(n.data("thumbs-delegate"),function(n){var i=n[0],s=n[1];e.events[i+" ."+r]=s,t&&e.listenTo(t,i,e[s])})}}),this.delegateEvents(),this}},Identifier={__identifiers:null,initialize:function(){this.__identifiers=[],this._super("initialize",arguments)},removeIdentifiers:function(){_.each(this.__identifiers,function(e){this[e]=this["$"+e]=null},this),this.__identifiers=[]},checkForIdentifiers:function(){var e=this;return this.removeIdentifiers(),this.$("[data-thumbs-id]").each(function(t){if(viewRegistry.getEnclosingView(this)===e){var n=$(this),r=n.data("thumbs-id");e[r]=this,e["$"+r]=viewRegistry.getByNode(this)||n,e.__identifiers.push(r)}}),this},render:function(){return this._super("render",arguments),this.checkForIdentifiers(),this},remove:function(){return this.removeIdentifiers(),this._super("remove",arguments)}},Binder={__monitors:null,__events:null,initialize:function(){this._super("initialize",arguments),this.__monitors={},this.__events={},_.bindAll(this,"setElData","__updateValues","__setValues","setupType","setupBind","setupClassBind","setupEventBind","findThumbsBind","turnOnModelListeners","turnOffModelListeners","setupBinders")},__updateValues:function(){if(this.model&&this.model instanceof Model)return this.__setValues(this.model.changedAttributes())},__setValues:function(e){var t=this.__monitors;return t&&_.each(e,function(e,n){var r=t[n];r&&_.each(r,function(t){t(e)})}),this},setElData:function(e,t,n,r){this.checkFormatting(e,t,n)},setupType:function(e,t,n){var r=this.__monitors;e in r||(r[e]=[]);var i=this.setElData;r[e].push(function(r){"function"==typeof t?t(r,e):i(t,r,n,e)})},setupBind:function(e){var t=$(e),n=this.setupType;splitParts(t.data("thumbs-bind"),function(t){if(t.length===1)n(t[0],e);else{if(t.length!==2)throw new TypeError("Invalid data-thumbs-bind definition");n(t[1],e,t[0])}})},setupClassBind:function(e){var t=$(e),n=this.setupType;splitParts(t.data("thumbs-bind-class"),function(e){if(e.length!==2)throw new TypeError("Invalid data-thumbs-bind-class definition");var r=e[0];n(e[1],function(e){t.toggleClass(r,e)})})},setupEventBind:function(e){var t=this.__events,n=$(e),r=this;splitParts(n.data("thumbs-bind-event"),function(e){if(e.length!==2)throw new TypeError("Invalid data-thumbs-bind-class definition");var n=e[0],i=t[n];i||(i=t[n]=[]),i.push(r[e[1]])})},findThumbsBind:function(){var e=this.setupBind,t=this.setupClassBind,n=this.setupEventBind;return this.$("[data-thumbs-bind]").each(function(){e(this)}),this.$("[data-thumbs-bind-event]").each(function(){n(this)}),this.$("[data-thumbs-bind-class]").each(function(){t(this)}),this.$el.is("[data-thumbs-bind]")&&e(this.el),this.$el.is("[data-thumbs-bind-class]")&&t(this.el),this.$el.is("[data-thumbs-bind-event]")&&n(this.el),this},turnOnModelListeners:function(){var e=this.model||this.collection;if(e){var t=this.__monitors,n=this.__events;t&&_.each(this.__monitors,function(t,n){t.fn=function(e,n){_.each(t,function(e){e.apply(this,[n])},this)},e.on("change:"+n,t.fn,this)},this),n&&_.each(this.__events,function(t,n){t.fn=function(){var e=arguments;_.each(t,function(t){t.apply(this,e)},this)},e.on(n,t.fn,this)},this)}return this},turnOffModelListeners:function(){var e=this.model||this.collection;if(e){var t=this.__monitors,n=this.__events;t&&_.each(this.__monitors,function(t,n){e.off("change:"+n,t.fn,this)},this),n&&_.each(this.__events,function(t,n){e.off(n,t.fn,this)},this)}return this},setupBinders:function(){var e=this.model||this.collection;return this.turnOffModelListeners().findThumbsBind().turnOnModelListeners(),e&&this.__setValues(e.attributes),this},render:function(){return this._super("render",arguments),this.setupBinders(),this},remove:function(){return this.turnOffModelListeners(),this.__monitors={},this.__events={},this._super("remove",arguments)}},Formatter={checkFormatting:function(e,t,n){var r=this.$(e),i=argsToArray(arguments);t=i.length>1?t:r.text(),t=t!==null&&"undefined"!=typeof t?t:"";var s=r.data("thumbs-format");splitParts(s||"",function(e){e.length===2?(n=e[0],s=e[1]):s=e.pop()}),s&&"function"==typeof this[s]&&(t=this[s](t)),setElData(r,t,n)},renderFormatters:function(){var e=_.bind(this.checkFormatting,this);return this.$("[data-thumbs-format]").each(function(){e(this)}),this},render:function(){return this._super("render",arguments),this.renderFormatters()}},ElFinder={findEl:function(){var e=_.bind(this.setElement,this),t=this.$("[data-thumbs-el]").first().get();return t.length&&(t=t[0],t!==this.el&&e(t)),this},render:function(){return this.findEl()._super("render",arguments)}},Subview={_subviews:null,initialize:function(){this._super("initialize",arguments),this.__subviews=[]},render:function(){return this.checkForSubviews(),this._super("render",arguments),this},remove:function(){return this._subviews.length&&(_.each(this.__subviews,function(e){e.remove()}),this.__subviews.length=0),this._super("remove",arguments)},_parseViewArgs:function(args){var ret={};if(args)try{_.extend(ret,eval("with(this){({"+args+"})}"))}catch(e){throw new Error("Unable to parse data-thumbs-args : "+args+" : "+e.toString())}return ret},renderSubviewView:function(e){var t=null,n,r=$(e),i=r.data("thumbs-view");if(!i||!(t=this[i]))throw new Error("Unable to find "+i+" on view");var s=this._parseViewArgs(r.data("thumbs-args"));_.extend(s,{el:e});var o=new t(s);return this.__subviews.push(o.render()),!(n=r.data("thumbs-id"))||(this["$"+n]=o),this},checkForSubviews:function(){var e=this;this.$("[data-thumbs-view]").each(function(){e.renderSubviewView(this)})}};return thumbs.templater=function(){var e=_.template;return function(n){return n?e=n:e}}(),thumbs.Router=Router.extend({route:function(e,t,n){return this._super("route",arguments),thumbs.history||(thumbs.history=Backbone.history),this}}),View=thumbs.View=View.extend(ElFinder).extend(Formatter).extend(Identifier).extend(Binder).extend(EventDelegator).extend(Subview).extend({_subviews:null,initialize:function(e){this.thumbsId=viewRegistry.uniqueId(),viewRegistry.add(this),this._super("initialize",arguments),this._subviews={},this.$el&&this.$el.attr("thumbs-id",this.thumbsId)},setElement:function(){var e=this._super("setElement",arguments);return this.el?this.$el.attr("thumbs-id",this.thumbsId):viewRegistry.remove(this.thumbsId),this},addSubView:function(e,t){return t&&(this.removeSubView(e),this._subviews[e]=t,t.setElement(this.$(e)).render()),this},removeSubView:function(e){var t=this._subviews[e];return t&&(t.setElement(null),t.remove(),this.$(e).empty(),this._subviews[e]=null),this},removeSubViews:function(){return _.each(this._subviews,function(e,t){this.removeSubView(t)},this),this},render:function(){return this._super("render",arguments),this.assign(this._subviews)},assign:function(e,t){var n;return _.isObject(e)?n=e:e&&(n={},n[e]=t),n&&_.each(n,function(e,t){this.addSubView(t,e)},this),this},remove:function(){return this.removeSubViews(),this.stopListening(),this._super("remove",arguments)}}),thumbs.TemplateView=View.extend({templater:null,template:null,initialize:function(e){this._super("initialize",arguments),this.templater||(this.templater=thumbs.templater()),this.template&&(this._template=this.templater(this.template))},getTemplateData:function(){return this.model||this.collection?(this.model||this.collection).toJSON():{}},fillTemplate:function(e){return this._template?this._template(e||this.getTemplateData()):null},renderTemplate:function(){if(this._template){var e=this.fillTemplate();e&&this.$el.html(e)}return this},render:function(){this.renderTemplate()._super("render",arguments)}}),thumbs}"undefined"!=typeof exports?"undefined"!=typeof module&&module.exports&&(module.exports=defineThumbs(Backbone||require("backbone"),_||require("underscore"))):"function"==typeof define?define(["require"],function(e){return defineThumbs(e("backbone"),e("underscore"))}):this.thumbs=defineThumbs(Backbone,_)}).call(this);